name: Free Windows RDP via LocalTunnel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Táº¡o user RDP
      shell: pwsh
      run: |
        Write-Host "==> Táº¡o user RDP..."
        net user rdpuser Huyhz@123 /add
        net localgroup administrators rdpuser /add
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "âœ… User rdpuser táº¡o xong."

    - name: CÃ i Ä‘áº·t LocalTunnel
      shell: pwsh
      run: |
        Write-Host "==> CÃ i Node.js vÃ  LocalTunnel..."
        npm install -g localtunnel
        Write-Host "âœ… LocalTunnel Ä‘Ã£ sáºµn sÃ ng."

    - name: Cháº¡y LocalTunnel Ä‘á»ƒ má»Ÿ cá»•ng RDP
      shell: pwsh
      run: |
        Write-Host "==> Äang khá»Ÿi cháº¡y LocalTunnel tá»›i cá»•ng 3389..."
        Start-Process -FilePath "lt" -ArgumentList "--port", "3389" -RedirectStandardOutput "lt_log.txt" -NoNewWindow
        Start-Sleep -Seconds 10

        # Äá»c link public
        $tries = 0
        $link = $null
        while (-not $link -and $tries -lt 30) {
          if (Test-Path "lt_log.txt") {
            $log = Get-Content "lt_log.txt" -Raw
            if ($log -match "https://[-a-z0-9]+\.loca\.lt") {
              $link = $matches[0]
              break
            }
          }
          Start-Sleep -Seconds 2
          $tries++
        }

        if ($link) {
          Write-Host ""
          Write-Host "âœ… âœ… âœ…  Káº¾T Ná»I THÃ€NH CÃ”NG  âœ… âœ… âœ…"
          Write-Host "ðŸŒ LINK: $link"
          Write-Host "ðŸ‘¤ USER: rdpuser"
          Write-Host "ðŸ”‘ PASS: Huyhz@123"
          Write-Host "âš ï¸ DÃ¹ng link nÃ y Ä‘á»ƒ táº¡o káº¿t ná»‘i proxy tá»›i RDP (TCP 3389)."
        } else {
          Write-Host "âŒ KhÃ´ng thá»ƒ láº¥y link LocalTunnel, cÃ³ thá»ƒ server Ä‘ang quÃ¡ táº£i."
        }

    - name: Giá»¯ RDP hoáº¡t Ä‘á»™ng 6 tiáº¿ng
      shell: pwsh
      run: |
        Write-Host "==> Giá»¯ RDP hoáº¡t Ä‘á»™ng trong 6 tiáº¿ng..."
        Start-Sleep -Seconds 21600
