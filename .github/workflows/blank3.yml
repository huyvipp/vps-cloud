name: Windows RDP via NodeJS LocalTunnel

on:
  workflow_dispatch:

jobs:
  rdp-localtunnel:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Info
      run: echo "Starting Windows RDP via localtunnel..."

    - name: Setup NodeJS
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Create RDP user & enable RDP
      shell: pwsh
      run: |
        Write-Host "==> Creating RDP user..."
        $pass = "Huyhz@123"
        if (Get-LocalUser -Name rdpuser -ErrorAction SilentlyContinue) {
          Write-Host "User exists, resetting password..."
          Set-LocalUser -Name "rdpuser" -Password (ConvertTo-SecureString $pass -AsPlainText -Force)
        } else {
          New-LocalUser -Name "rdpuser" -Password (ConvertTo-SecureString $pass -AsPlainText -Force)
        }
        Add-LocalGroupMember -Group "Administrators" -Member "rdpuser" -ErrorAction SilentlyContinue
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "‚úÖ User: rdpuser | Pass: $pass"

    - name: Install LocalTunnel
      shell: pwsh
      run: |
        npm install -g localtunnel
        Write-Host "‚úÖ LocalTunnel installed."

    - name: Start LocalTunnel
      shell: pwsh
      run: |
        Write-Host "==> Starting localtunnel on port 3389..."
        $logOut = "$env:RUNNER_TEMP\lt_out.txt"
        $logErr = "$env:RUNNER_TEMP\lt_err.txt"

        # Start process and redirect output separately to avoid PowerShell bug
        $proc = Start-Process -FilePath "npx" `
          -ArgumentList "localtunnel","--port","3389" `
          -RedirectStandardOutput $logOut `
          -RedirectStandardError $logErr `
          -NoNewWindow -PassThru

        Write-Host "Process started PID=$($proc.Id)"
        Start-Sleep -Seconds 5

        $link = $null
        for ($i=0; $i -lt 40; $i++) {
          Start-Sleep -Seconds 2
          if (Test-Path $logOut) {
            $txt = Get-Content $logOut -Raw -ErrorAction SilentlyContinue
            if ($txt -match "https://[a-z0-9\-]+\.loca\.lt") {
              $link = $matches[0]
              break
            }
          }
        }

        if ($link) {
          Write-Host ""
          Write-Host "‚úÖ Found tunnel!"
          Write-Host "üîó Link: $link"
          Write-Host "üë§ User: rdpuser"
          Write-Host "üîë Pass: Huyhz@123"
          Write-Host ""
        } else {
          Write-Host "‚ùå Failed to get tunnel link. Dumping logs..."
          if (Test-Path $logOut) { Get-Content $logOut -Tail 20 }
          if (Test-Path $logErr) { Get-Content $logErr -Tail 20 }
          throw "No tunnel link found ‚Äî try re-running."
        }

    - name: Keep alive
      shell: pwsh
      run: |
        Write-Host "Keeping session alive for 6 hours..."
        for ($i=0; $i -lt 360; $i++) {
          Start-Sleep -Seconds 60
          if ($i % 10 -eq 0) { Write-Host "Alive $i minutes" }
        }
