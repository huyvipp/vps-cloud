name: Windows RDP via ngrok

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Show start
        run: echo "Starting Windows RDP setup..."

      - name: Configure RDP user & enable RDP
        shell: pwsh
        env:
          RDP_PASSWORD: ${{ 'Huyhz123@' }}
        run: |
          Write-Host "Creating local user 'rdpuser'..."
          $securePass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          if (Get-LocalUser -Name "rdpuser" -ErrorAction SilentlyContinue) {
              Write-Host "User exists, resetting password..."
              Set-LocalUser -Name "rdpuser" -Password $securePass
          } else {
              Write-Host "Creating new user..."
              New-LocalUser -Name "rdpuser" -Password $securePass -FullName "RDP User" -Description "User for RDP access"
          }

          Add-LocalGroupMember -Group "Administrators" -Member "rdpuser"

          Write-Host "Enabling Remote Desktop..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0

          Write-Host "Enabling firewall rules for RDP..."
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          Write-Host "âœ… RDP configured successfully."

      - name: Download ngrok
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip
          Copy-Item ngrok\ngrok.exe -Destination .

      - name: Start ngrok TCP tunnel for RDP
        env:
          NGROK_AUTH_TOKEN: ${{ '355xkUcr6M0FvUN2PTK95Thc2Oe_2MSosbmm57GYoMJP7dUiR' }}
        run: |
          .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
          Start-Process -FilePath .\ngrok.exe -ArgumentList "tcp 3389" -NoNewWindow
          Start-Sleep -Seconds 10
          Invoke-WebRequest -Uri "http://127.0.0.1:4040/api/tunnels" | Out-File tunnel.json
          Get-Content tunnel.json

      - name: Keep alive
        shell: pwsh
        run: |
          Write-Host "Runner will stay alive for 6 hours (360m)..."
          for ($i = 0; $i -lt 360; $i++) {
            Start-Sleep -Seconds 60
          }

