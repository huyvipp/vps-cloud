name: Windows RDP via ngrok

on:
  workflow_dispatch:

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: üß∞ Set up job
      run: |
        Write-Host "üöÄ Starting Windows RDP Setup..."

    - name: üîë Configure RDP user & enable RDP
      shell: pwsh
      env:
        RDP_PASSWORD: 'Huynh@123'
      run: |
        try {
          Write-Host "Creating local user 'rdpuser'..."
          $securePass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          if (Get-LocalUser -Name "rdpuser" -ErrorAction SilentlyContinue) {
              Write-Host "User exists, resetting password..."
              $user = Get-LocalUser -Name "rdpuser"
              $user | Set-LocalUser -Password $securePass
          } else {
              New-LocalUser "rdpuser" -Password $securePass -FullName "RDP User" -Description "RDP User account"
          }

          Add-LocalGroupMember -Group "Administrators" -Member "rdpuser"
          Write-Host "User added to Administrators group."

          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "‚úÖ RDP enabled successfully!"
        }
        catch {
          Write-Error "‚ùå Error configuring RDP: $_"
          exit 1
        }

    - name: üß± Download ngrok
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" -OutFile "ngrok.zip"
        Expand-Archive ngrok.zip
        Copy-Item .\ngrok\ngrok.exe .\ngrok.exe

    - name: üîê Connect ngrok account
      shell: pwsh
      env:
        NGROK_AUTH_TOKEN: ${{ '355xkUcr6M0FvUN2PTK95Thc2Oe_2MSosbmm57GYoMJP7dUiR' }}
      run: |
        Write-Host "Connecting ngrok account..."
        .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN

    - name: üöÄ Start ngrok TCP tunnel for RDP
      shell: pwsh
      run: |
        Start-Process -FilePath .\ngrok.exe -ArgumentList "tcp 3389" -NoNewWindow
        Write-Host "‚è≥ Waiting for ngrok to start..."
        $started = $false
        for ($i = 0; $i -lt 30; $i++) {
            Start-Sleep -Seconds 5
            try {
                Invoke-WebRequest -Uri "http://127.0.0.1:4040/api/tunnels" -UseBasicParsing | Out-File tunnel.json
                $started = $true
                break
            } catch {
                Write-Host "Still waiting... ($i)"
            }
        }
        if (-not $started) {
            Write-Error "‚ùå Ngrok failed to start within expected time!"
            exit 1
        }
        Write-Host "‚úÖ Ngrok started successfully."
        Get-Content tunnel.json

    - name: üñ•Ô∏è Print RDP connection info
      shell: pwsh
      run: |
        $json = Get-Content tunnel.json | ConvertFrom-Json
        $url = $json.tunnels.public_url
        Write-Host "=============================="
        Write-Host "‚úÖ RDP is Ready!"
        Write-Host "üëâ Address: $url"
        Write-Host "üëâ User: rdpuser"
        Write-Host "üëâ Pass: Huyhz@123"
        Write-Host "=============================="

    - name: ‚è≥ Keep runner alive (6h)
      shell: pwsh
      run: |
        Write-Host "Runner will stay alive for 6 hours..."
        for ($i = 0; $i -lt 360; $i++) {
          Start-Sleep -Seconds 60
          Write-Host "Still alive ($i min)"
        }

