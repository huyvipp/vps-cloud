name: Windows RDP via Serveo (No Card, Stable)

on:
  workflow_dispatch:

jobs:
  rdp-serveo:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Setup RDP
      shell: pwsh
      run: |
        $pass = "Huyhz@123"
        Write-Host "==> Creating user..."
        if (Get-LocalUser -Name rdpuser -ErrorAction SilentlyContinue) {
          Set-LocalUser -Name "rdpuser" -Password (ConvertTo-SecureString $pass -AsPlainText -Force)
        } else {
          New-LocalUser -Name "rdpuser" -Password (ConvertTo-SecureString $pass -AsPlainText -Force)
        }
        Add-LocalGroupMember -Group "Administrators" -Member "rdpuser"
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Run Serveo tunnel
      shell: pwsh
      run: |
        Write-Host "==> Starting Serveo SSH tunnel..."
        Start-Process -FilePath "ssh" -ArgumentList "-o StrictHostKeyChecking=no -R 3389:localhost:3389 serveo.net" -NoNewWindow
        Write-Host "âœ… Tunnel started. Connect with:"
        Write-Host "mstsc /v:serveo.net:3389"
        Write-Host "Username: rdpuser"
        Write-Host "Password: Huyhz@123"

    - name: Keep alive
      shell: pwsh
      run: |
        Write-Host "Keeping alive for 6 hours..."
        for ($i = 0; $i -lt 360; $i++) {
          Start-Sleep -Seconds 60
          if ($i % 10 -eq 0) { Write-Host "Alive $i minutes" }
        }
