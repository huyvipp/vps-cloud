name: RDP Cloudflare v3 Stable
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: üß† Chu·∫©n b·ªã
        run: |
          Write-Host "==> C√†i ƒë·∫∑t Cloudflared & b·∫≠t RDP..."
          Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
          net user runneradmin "Huyhz123@" /add
          net localgroup administrators runneradmin /add
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: üöÄ Kh·ªüi ch·∫°y Cloudflared tunnel
        run: |
          Write-Host "==> Starting Cloudflare tunnel..."
          Start-Process -NoNewWindow -FilePath ".\cloudflared.exe" -ArgumentList "tunnel", "run", "--url", "rdp://localhost:3389" -RedirectStandardOutput "cf.log" -RedirectStandardError "cf.log"
          Start-Sleep -Seconds 15
          $found = $false
          for ($i = 0; $i -lt 20; $i++) {
            if (Test-Path "cf.log") {
              $content = Get-Content cf.log -Raw
              if ($content -match "https://[a-zA-Z0-9-]+\.trycloudflare\.com") {
                $url = $matches[0]
                Write-Host "‚úÖ Link truy c·∫≠p RDP: $url"
                $found = $true
                break
              }
            }
            Start-Sleep -Seconds 5
          }
          if (-not $found) {
            Write-Host "‚ùå Kh√¥ng th·ªÉ t·∫°o tunnel Cloudflare."
            Get-Content cf.log
            exit 1
          }

      - name: üïì Gi·ªØ phi√™n ho·∫°t ƒë·ªông
        run: |
          Write-Host "Gi·ªØ phi√™n ho·∫°t ƒë·ªông trong 6 ti·∫øng..."
          Start-Sleep -Seconds 21600

