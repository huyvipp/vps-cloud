name: Windows RDP Cloudflare v2

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: ðŸ§° Setup user and enable RDP
      shell: pwsh
      run: |
        Write-Host "==> Setting up RDP user..."
        $password = ConvertTo-SecureString "Huynhz123@" -AsPlainText -Force
        if (Get-LocalUser -Name "rdpuser" -ErrorAction SilentlyContinue) {
          Set-LocalUser -Name "rdpuser" -Password $password
          Write-Host "User 'rdpuser' already exists. Password reset."
        } else {
          New-LocalUser "rdpuser" -Password $password -FullName "RDP User" -Description "Remote Desktop User"
          Write-Host "User 'rdpuser' created."
        }

        Add-LocalGroupMember -Group "Administrators" -Member "rdpuser" -ErrorAction SilentlyContinue
        Write-Host "âœ… User added to Administrators group."

        Write-Host "==> Enabling RDP..."
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "âœ… RDP Enabled!"

    - name: â˜ï¸ Install Cloudflared
      shell: pwsh
      run: |
        Write-Host "==> Installing Cloudflared..."
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
        Write-Host "âœ… Download complete."

    - name: ðŸŒ Start Cloudflare tunnel
      shell: pwsh
      run: |
        Write-Host "==> Starting Cloudflared tunnel..."
        Start-Process -NoNewWindow -FilePath ".\cloudflared.exe" -ArgumentList "tunnel", "--url", "rdp://localhost:3389", "--no-autoupdate" `
          -RedirectStandardOutput "cloudflared-out.log" -RedirectStandardError "cloudflared-err.log"

        Start-Sleep -Seconds 10
        $tryCount = 0
        $link = $null
        while ($tryCount -lt 20 -and $null -eq $link) {
          Start-Sleep -Seconds 3
          if (Test-Path "cloudflared-out.log") {
            $content = Get-Content "cloudflared-out.log" -Raw
            if ($content -match "https://[a-zA-Z0-9-]+\.trycloudflare\.com") {
              $link = $matches[0]
              break
            }
          }
          $tryCount++
        }

        if ($null -eq $link) {
          Write-Host "âŒ Could not get tunnel link. Showing last log lines:"
          if (Test-Path "cloudflared-err.log") {
            Get-Content "cloudflared-err.log" -Tail 15
          }
          exit 1
        }

        Write-Host "`n=============================================="
        Write-Host "âœ… RDP Ready!"
        Write-Host "ðŸŒ Link: $link"
        Write-Host "ðŸ‘¤ User: rdpuser"
        Write-Host "ðŸ”‘ Pass: Huynhz123@"
        Write-Host "=============================================="

    - name: ðŸ•’ Keep alive
      shell: pwsh
      run: |
        Write-Host "==> Keeping VM alive for 6 hours..."
        Start-Sleep -Seconds 21600

