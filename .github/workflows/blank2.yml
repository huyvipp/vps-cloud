name: Windows RDP via Cloudflared (Final Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Thiáº¿t láº­p user RDP
      shell: pwsh
      run: |
        Write-Host "==> Äang táº¡o user RDP..."
        net user rdpuser Huyhz@123 /add
        net localgroup administrators rdpuser /add
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "âœ… User 'rdpuser' Ä‘Ã£ sáºµn sÃ ng!"

    - name: CÃ i Ä‘áº·t Cloudflared
      shell: pwsh
      run: |
        Write-Host "==> Äang táº£i Cloudflared..."
        Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        Write-Host "âœ… Cloudflared táº£i xong!"

    - name: Khá»Ÿi cháº¡y Cloudflared tunnel & láº¥y link
      shell: pwsh
      run: |
        Write-Host "==> Äang khá»Ÿi cháº¡y Cloudflared tunnel tá»›i RDP..."
        $p = Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel", "--url", "rdp://localhost:3389" -RedirectStandardOutput "cloudflared_out.txt" -PassThru
        Write-Host "â³ Äá»£i 20 giÃ¢y Ä‘á»ƒ tunnel khá»Ÿi táº¡o..."
        Start-Sleep -Seconds 20

        # Äá»c real-time output Ä‘á»ƒ tÃ¬m link
        $link = $null
        $tries = 0
        while (-not $link -and $tries -lt 60) {
          if (Test-Path "cloudflared_out.txt") {
            $lines = Get-Content "cloudflared_out.txt" -Raw
            if ($lines -match "https://[-a-z0-9]+\.trycloudflare\.com") {
              $link = $matches[0]
              break
            }
          }
          Start-Sleep -Seconds 2
          $tries++
        }

        if ($link) {
          Write-Host ""
          Write-Host "âœ… âœ… âœ…  Káº¾T Ná»I RDP THÃ€NH CÃ”NG  âœ… âœ… âœ…"
          Write-Host "ðŸ”— LINK: $link"
          Write-Host "ðŸ‘¤ USER: rdpuser"
          Write-Host "ðŸ”‘ PASS: Huyhz@123"
        } else {
          Write-Host "âŒ KhÃ´ng thá»ƒ láº¥y link Cloudflare. CÃ³ thá»ƒ Cloudflared chÆ°a táº¡o tunnel."
          Write-Host "Thá»­ cháº¡y láº¡i job hoáº·c kiá»ƒm tra output cloudflared_out.txt."
        }

    - name: Giá»¯ RDP hoáº¡t Ä‘á»™ng 6 tiáº¿ng
      shell: pwsh
      run: |
        Write-Host "==> Giá»¯ phiÃªn RDP trong 6 tiáº¿ng..."
        Start-Sleep -Seconds 21600
