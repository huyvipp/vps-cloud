name: Windows RDP via Cloudflared (Fixed Regex)

on:
  workflow_dispatch:

jobs:
  rdp-cloudflared:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Prepare / info
      run: echo "Starting Windows RDP via Cloudflared..."

    - name: Create RDP user & enable RDP
      shell: pwsh
      run: |
        $pass = "Huyhz@123"
        Write-Host "==> Creating or updating user 'rdpuser'..."
        if (Get-LocalUser -Name rdpuser -ErrorAction SilentlyContinue) {
          Set-LocalUser -Name "rdpuser" -Password (ConvertTo-SecureString $pass -AsPlainText -Force)
        } else {
          New-LocalUser -Name "rdpuser" -Password (ConvertTo-SecureString $pass -AsPlainText -Force) -FullName "RDP User"
        }
        Add-LocalGroupMember -Group "Administrators" -Member "rdpuser" -ErrorAction SilentlyContinue
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "✅ RDP user ready: rdpuser / $pass"

    - name: Download cloudflared
      shell: pwsh
      run: |
        $url = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
        Write-Host "Downloading cloudflared..."
        Invoke-WebRequest -Uri $url -OutFile cloudflared.exe

    - name: Start cloudflared tunnel
      shell: pwsh
      run: |
        Write-Host "==> Starting cloudflared tunnel..."
        $log = Join-Path $env:RUNNER_TEMP "cloudflared_out.txt"
        if (Test-Path $log) { Remove-Item $log -Force }
        $proc = Start-Process -FilePath ".\cloudflared.exe" `
          -ArgumentList "tunnel","--url","tcp://localhost:3389","--no-autoupdate" `
          -RedirectStandardOutput $log -RedirectStandardError $log -NoNewWindow -PassThru

        Write-Host "Started cloudflared PID=$($proc.Id). Waiting for public endpoint..."

        $link = $null
        $attempt = 0
        while (-not $link -and $attempt -lt 60) {
          Start-Sleep -Seconds 5
          if (Test-Path $log) {
            $text = Get-Content $log -Raw -ErrorAction SilentlyContinue
            # escaped square brackets for PowerShell regex
            if ($text -match "tcp://[^\s`""]+") { $link = $matches[0]; break }
            elseif ($text -match "https?://[-a-z0-9]+\.trycloudflare\.com(:\d+)?") { $link = $matches[0]; break }
            elseif ($text -match "[-a-z0-9]+\.trycloudflare\.com:\d+") { $link = $matches[0]; break }
          }
          $attempt++
          Write-Host "Waiting... attempt $attempt/60"
        }

        if ($link) {
          Write-Host "`n✅ CLOUD FLARE TUNNEL READY"
          Write-Host "Public endpoint: $link"
          Write-Host "Username: rdpuser"
          Write-Host "Password: Huyhz@123"
          Write-Host "Example: mstsc /v:$link"
        } else {
          Write-Host "❌ Could not get Cloudflare link."
          if (Test-Path $log) { Get-Content $log -Tail 200 } else { Write-Host "No log file found." }
          throw "cloudflared tunnel not available"
        }

    - name: Keep alive
      shell: pwsh
      run: |
        Write-Host "Keeping alive for 6 hours..."
        for ($i = 0; $i -lt 360; $i++) {
          Start-Sleep -Seconds 60
          if ($i % 10 -eq 0) { Write-Host "Alive $i minutes" }
        }
