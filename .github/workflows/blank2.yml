name: Windows RDP via Cloudflared (Fixed Link Output)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Táº¡o user RDP
      shell: pwsh
      run: |
        Write-Host "==> Táº¡o user 'rdpuser'..."
        net user rdpuser Huyhz@123 /add
        net localgroup administrators rdpuser /add
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: CÃ i Cloudflared
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe

    - name: Khá»Ÿi Ä‘á»™ng Cloudflared Tunnel
      shell: pwsh
      run: |
        Write-Host "==> Khá»Ÿi cháº¡y Cloudflared tunnel..."
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel", "--url", "rdp://localhost:3389" -RedirectStandardOutput "cloudflared.log" -NoNewWindow
        Write-Host "â³ Äang khá»Ÿi táº¡o káº¿t ná»‘i... (chá» ~20 giÃ¢y)"
        Start-Sleep -Seconds 20

        # Äá»c log Ä‘á»ƒ láº¥y link trycloudflare
        $attempts = 0
        $link = $null
        while (-not $link -and $attempts -lt 30) {
          Start-Sleep -Seconds 2
          if (Test-Path "cloudflared.log") {
            $content = Get-Content "cloudflared.log" -Raw
            if ($content -match "https://[-a-z0-9]+\.trycloudflare\.com") {
              $link = $matches[0]
            }
          }
          $attempts++
        }

        if ($link) {
          Write-Host "âœ… ====> LINK RDP: $link"
          Write-Host "ðŸ‘‰ DÃ¹ng link trÃªn lÃ m server RDP."
        } else {
          Write-Host "âŒ KhÃ´ng tÃ¬m tháº¥y link Cloudflare, thá»­ cháº¡y láº¡i job."
        }

    - name: Giá»¯ phiÃªn hoáº¡t Ä‘á»™ng 6 tiáº¿ng
      shell: pwsh
      run: |
        Write-Host "==> RDP sáº½ hoáº¡t Ä‘á»™ng trong 6 tiáº¿ng..."
        Start-Sleep -Seconds 21600
