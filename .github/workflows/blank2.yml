name: Windows RDP Cloudflare

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: ðŸªŸ Setup RDP user
      shell: pwsh
      run: |
        Write-Host "==> Creating user 'rdpuser'..."
        $password = ConvertTo-SecureString "Huynhz123@" -AsPlainText -Force
        if (Get-LocalUser -Name "rdpuser" -ErrorAction SilentlyContinue) {
          Write-Host "User exists, resetting password..."
          Set-LocalUser -Name "rdpuser" -Password $password
        } else {
          Write-Host "Creating new user..."
          New-LocalUser "rdpuser" -Password $password -FullName "RDP User" -Description "Remote User"
        }

        Write-Host "==> Adding user to Administrators group..."
        Add-LocalGroupMember -Group "Administrators" -Member "rdpuser" -ErrorAction SilentlyContinue
        Write-Host "âœ… User created and added to admin group."

    - name: âš™ï¸ Enable RDP service
      shell: pwsh
      run: |
        Write-Host "==> Enabling RDP..."
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "âœ… RDP service is enabled."

    - name: â˜ï¸ Install Cloudflared
      shell: pwsh
      run: |
        Write-Host "==> Downloading Cloudflared..."
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
        Write-Host "âœ… Cloudflared downloaded."

    - name: ðŸŒ Start Cloudflared tunnel
      shell: pwsh
      run: |
        Write-Host "==> Starting Cloudflared tunnel..."
        Start-Process -NoNewWindow -FilePath ".\cloudflared.exe" -ArgumentList "tunnel", "--url", "rdp://localhost:3389", "--no-autoupdate" -RedirectStandardOutput "cloudflared.log" -RedirectStandardError "cloudflared.log"
        Start-Sleep -Seconds 10

        $link = $null
        for ($i=0; $i -lt 15; $i++) {
          if (Test-Path "cloudflared.log") {
            $text = Get-Content "cloudflared.log" -Raw
            if ($text -match "trycloudflare.com") {
              $link = ($matches[0])
              break
            }
          }
          Start-Sleep -Seconds 3
        }

        if ($null -eq $link) {
          Write-Host "âŒ Could not get Cloudflare link. Check cloudflared.log"
          exit 1
        } else {
          Write-Host "âœ… Your RDP link: $link"
          Write-Host "Username: rdpuser"
          Write-Host "Password: Huynhz123@"
        }

    - name: ðŸ•’ Keep alive
      shell: pwsh
      run: |
        Write-Host "==> Keeping RDP alive for 6 hours..."
        Start-Sleep -Seconds 21600
