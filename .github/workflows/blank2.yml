name: Windows Cloudflared Tunnel (V5 Fixed)

on:
  workflow_dispatch:

jobs:
  tunnel:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Setup PowerShell
      shell: pwsh
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force

    - name: Download Cloudflared
      shell: pwsh
      run: |
        $url = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
        Invoke-WebRequest -Uri $url -OutFile "cloudflared.exe"
        Write-Host "‚úÖ Cloudflared downloaded."

    - name: Start Cloudflared tunnel
      shell: pwsh
      run: |
        Write-Host "==> Starting Cloudflared tunnel..."

        $stdout = "$env:RUNNER_TEMP\cloudflared_out.log"
        $stderr = "$env:RUNNER_TEMP\cloudflared_err.log"

        # Ch·∫°y Cloudflared, ghi ra hai file log ri√™ng bi·ªát
        $proc = Start-Process -FilePath ".\cloudflared.exe" `
            -ArgumentList "tunnel", "--url", "http://localhost:8080", "--no-autoupdate" `
            -RedirectStandardOutput $stdout `
            -RedirectStandardError $stderr `
            -PassThru

        Write-Host "Cloudflared started with PID $($proc.Id). Waiting for URL..."

        $url = $null
        $timeout = (Get-Date).AddSeconds(60)

        while ((Get-Date) -lt $timeout -and -not $url) {
            Start-Sleep -Seconds 3
            $lines = @()
            if (Test-Path $stdout) { $lines += Get-Content $stdout -Tail 20 -ErrorAction SilentlyContinue }
            if (Test-Path $stderr) { $lines += Get-Content $stderr -Tail 20 -ErrorAction SilentlyContinue }

            foreach ($line in $lines) {
                if ($line -match "https://[-a-z0-9]+\.trycloudflare\.com") {
                    $url = $matches[0]
                    break
                }
            }
        }

        if (-not $url) {
            Write-Host "‚ùå No Cloudflare URL found."
            Write-Host "=== STDOUT ==="
            if (Test-Path $stdout) { Get-Content $stdout -Tail 30 }
            Write-Host "=== STDERR ==="
            if (Test-Path $stderr) { Get-Content $stderr -Tail 30 }
            throw "Cloudflared failed to start or no URL received."
        }

        Write-Host "‚úÖ Tunnel established successfully!"
        Write-Host "::notice::Your Cloudflare Tunnel URL: $url"
        Write-Host "üåê Access: $url"

        # Gi·ªØ k·∫øt n·ªëi s·ªëng 6 ti·∫øng
        while (-not $proc.HasExited) {
            Start-Sleep -Seconds 60
        }
