name: Windows Cloudflare RDP (Stable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
    - name: ðŸ”§ Setup User
      run: |
        Write-Host "==> Setting up RDP user..."
        net user runneradmin Huyhz123@ /add
        net localgroup administrators runneradmin /add
        net localgroup "Remote Desktop Users" runneradmin /add
        Write-Host "âœ… User created successfully!"

    - name: âš™ï¸ Enable RDP
      run: |
        Write-Host "==> Enabling RDP..."
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "âœ… RDP Enabled!"

    - name: ðŸ“¦ Download Cloudflared
      run: |
        Write-Host "==> Downloading Cloudflared..."
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        Write-Host "âœ… Cloudflared downloaded!"

    - name: ðŸŒ Start Cloudflare Tunnel
      run: |
        Write-Host "==> Starting Cloudflare tunnel..."
        $env:CLOUDFLARED_NO_AUTUPDATE = "true"
        $proc = Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel", "--url", "rdp://localhost:3389", "--metrics", "localhost:8080" -PassThru -RedirectStandardOutput ".\cloudflared_out.log" -RedirectStandardError ".\cloudflared_err.log"
        Start-Sleep -Seconds 10
        $output = Get-Content .\cloudflared_out.log -Raw
        if ($output -match "https://[-a-zA-Z0-9.]+trycloudflare.com") {
          $url = $matches[0]
          Write-Host "âœ… Tunnel started successfully!"
          Write-Host "ðŸŒ Your RDP Link: $url"
          Write-Host "ðŸªª Username: runneradmin"
          Write-Host "ðŸ”‘ Password: Huyhz123@"
        } else {
          Write-Host "âŒ Cloudflare tunnel failed to start. Logs below:"
          Get-Content .\cloudflared_err.log
          exit 1
        }

    - name: ðŸ•’ Keep Session Alive
      run: |
        Write-Host "==> Keeping RDP session alive..."
        while ($true) {
          Start-Sleep -Seconds 600
        }
