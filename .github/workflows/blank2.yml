name: Windows Cloudflare RDP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Setup RDP User
      run: |
        Write-Host "==> Creating user and enabling RDP..."
        net user runneradmin Password123! /add
        net localgroup administrators runneradmin /add
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="remote desktop" new enable=yes
        Write-Host "‚úÖ RDP enabled with user: runneradmin / Password123!"

    - name: Download Cloudflared
      run: |
        Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        Write-Host "‚úÖ Cloudflared downloaded."

    - name: Start Cloudflared Tunnel
      shell: pwsh
      run: |
        Write-Host "==> Starting Cloudflared tunnel..."
        $proc = Start-Process -FilePath ".\cloudflared.exe" `
          -ArgumentList "tunnel --url http://localhost:3389" `
          -NoNewWindow -PassThru `
          -RedirectStandardOutput ".\cloudflared_log.txt" `
          -RedirectStandardError ".\cloudflared_err.txt"

        # Wait for the tunnel URL to appear
        $success = $false
        for ($i=0; $i -lt 40; $i++) {
          Start-Sleep -Seconds 3
          if (Test-Path ".\cloudflared_log.txt") {
            $log = Get-Content ".\cloudflared_log.txt" -Raw
            if ($log -match "https://[-a-z0-9]+\.trycloudflare\.com") {
              $url = ($matches[0])
              Write-Host "`n‚úÖ RDP Tunnel ready at: $url"
              $success = $true
              break
            }
          }
        }

        if (-not $success) {
          Write-Host "‚ùå Cloudflared failed to start. Showing log:"
          Get-Content ".\cloudflared_err.txt" -ErrorAction SilentlyContinue
          throw "Cloudflared failed to start or no URL received."
        }

    - name: Keep alive
      run: |
        Write-Host "üîÑ Keeping session alive for 6 hours..."
        Start-Sleep -Seconds 21600
