name: Windows Cloudflared Tunnel (v4 Stable)

on:
  workflow_dispatch:

jobs:
  tunnel:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Allow PowerShell scripts
      shell: pwsh
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force

    - name: Download Cloudflared
      shell: pwsh
      run: |
        $url = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
        Invoke-WebRequest -Uri $url -OutFile "cloudflared.exe"
        Write-Host "‚úÖ Cloudflared downloaded successfully."

    - name: Start Cloudflare tunnel
      shell: pwsh
      run: |
        Write-Host "==> Starting Cloudflared tunnel..."
        $logFile = "$env:RUNNER_TEMP\cloudflared_full.log"

        # Ch·∫°y Cloudflared trong background, merge stdout + stderr
        $proc = Start-Process -FilePath ".\cloudflared.exe" `
            -ArgumentList "tunnel", "--url", "rdp://localhost:8080", "--no-autoupdate" `
            -RedirectStandardOutput $logFile `
            -RedirectStandardError $logFile `
            -PassThru

        Write-Host "Cloudflared started with PID $($proc.Id), waiting for URL..."

        $url = $null
        $timeout = (Get-Date).AddSeconds(60)
        while ((Get-Date) -lt $timeout -and -not $url) {
            Start-Sleep -Seconds 3
            if (Test-Path $logFile) {
                $lines = Get-Content $logFile -Tail 20 -ErrorAction SilentlyContinue
                foreach ($line in $lines) {
                    if ($line -match "https://[-a-z0-9]+\.trycloudflare\.com") {
                        $url = $matches[0]
                        break
                    }
                }
            }
        }

        if (-not $url) {
            Write-Host "‚ùå No tunnel URL found in logs. Dumping last log lines:"
            Get-Content $logFile -Tail 30
            throw "Cloudflared failed to start or no URL received."
        }

        Write-Host "‚úÖ Tunnel established!"
        Write-Host "::notice::Your public URL: $url"
        Write-Host "üåê Access via: $url"

        # Gi·ªØ k·∫øt n·ªëi s·ªëng 6 ti·∫øng
        while (-not $proc.HasExited) {
            Start-Sleep -Seconds 60
        }

        # gi·ªØ ti·∫øn tr√¨nh ch·∫°y 6h
        Write-Host "Keeping Cloudflared alive..."
        while (-not $proc.HasExited) {
            Start-Sleep -Seconds 60
        }
