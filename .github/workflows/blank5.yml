name: Windows 11 RDP + VNC Cloud Tunnel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
      - name: ‚öôÔ∏è Setup environment
        run: |
          echo "Setting up environment..."
          Set-ExecutionPolicy Bypass -Scope Process -Force
          cd $env:TEMP

      - name: ü™ü Enable RDP & create user
        run: |
          echo "Enabling RDP and creating user..."
          net user runneradmin /active:yes
          net user githubRDP Passw0rd! /add
          net localgroup administrators githubRDP /add
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=yes
          echo "‚úÖ RDP Enabled."

      - name: üåê Install cloudflared + serveo + ngrok
        run: |
          echo "Downloading tunnels..."
          iwr -useb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
          curl -s -o serveo.ps1 https://raw.githubusercontent.com/burton999dev/serveo-connect/main/serveo.ps1
          npm install -g localtunnel >$null 2>&1
          echo "‚úÖ Tunnel tools installed."

      - name: üöÄ Start cloudflared tunnel
        run: |
          echo "Starting Cloudflare tunnel..."
          Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url rdp://localhost:3389" -WindowStyle Hidden
          Start-Sleep -Seconds 10
          Get-Content cloudflared.log -ErrorAction SilentlyContinue | Select-String "trycloudflare.com"

      - name: üß† Fallback Serveo if Cloudflare fails
        run: |
          echo "Trying Serveo if Cloudflare failed..."
          if (-not (Get-Content cloudflared.log -ErrorAction SilentlyContinue | Select-String "trycloudflare.com")) {
            echo "‚òÅÔ∏è Cloudflare failed, using Serveo..."
            ssh -R 3389:localhost:3389 serveo.net -o StrictHostKeyChecking=no -o ServerAliveInterval=60
          }

      - name: üñ•Ô∏è Launch noVNC web viewer
        run: |
          echo "Installing and running noVNC..."
          Invoke-WebRequest -Uri https://github.com/novnc/noVNC/archive/refs/heads/master.zip -OutFile novnc.zip
          Expand-Archive novnc.zip -DestinationPath .
          cd noVNC-master
          Start-Process "npx" -ArgumentList "http-server -p 6080" -WindowStyle Hidden
          echo "‚úÖ noVNC web server started on port 6080"

      - name: üí¨ Show connection info
        run: |
          echo "========================================"
          echo "‚úÖ RDP User: githubRDP"
          echo "‚úÖ RDP Pass: Passw0rd!"
          echo "‚úÖ VNC: http://<your-public-tunnel>:6080/vnc.html"
          echo "If Cloudflare works, find link in cloudflared.log"
          echo "========================================"
