name: Windows Cloudflare VNC
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: ðŸ”§ Setup environment
        run: |
          Write-Host "Preparing Windows environment..."
          Set-ExecutionPolicy Bypass -Scope Process -Force

      - name: ðŸ§  Enable RDP & Set password
        continue-on-error: true
        run: |
          net user runneradmin Huyhz123@
          net localgroup administrators runneradmin /add 2>$null
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "âœ… RDP Enabled with password:Huyhz123@"

      - name: ðŸ–¥ï¸ Download & Setup noVNC
        run: |
          Invoke-WebRequest -Uri https://github.com/novnc/noVNC/archive/refs/heads/master.zip -OutFile novnc.zip
          Expand-Archive novnc.zip -DestinationPath .
          Rename-Item noVNC-master novnc
          Invoke-WebRequest -Uri https://github.com/novnc/websockify/archive/refs/heads/master.zip -OutFile websockify.zip
          Expand-Archive websockify.zip -DestinationPath .
          Rename-Item websockify-master websockify

      - name: ðŸ§° Install Python
        run: |
          choco install -y python
          python -m pip install --upgrade pip

      - name: ðŸŒ Start VNC server
        run: |
          choco install -y tightvnc
          & "C:\Program Files\TightVNC\tvnserver.exe" -install
          & "C:\Program Files\TightVNC\tvnserver.exe" -start
          Write-Host "âœ… TightVNC started on port 5900"

      - name: ðŸš€ Start noVNC + websockify
        run: |
          cd novnc
          Start-Process -NoNewWindow "python" "../websockify/run" "6080" "localhost:5900"
          Start-Sleep -Seconds 5
          Write-Host "âœ… noVNC started on port 6080"

      - name: â˜ï¸ Start Cloudflare Tunnel
        run: |
          Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
          Start-Process -WindowStyle Hidden -FilePath "python" -ArgumentList "../websockify/run", "6080", "localhost:5900"
          Write-Host "âœ… noVNC server started on port 6080"
          Start-Sleep -Seconds 15
          Get-Content cloudflared.log | Select-String "trycloudflare.com"

      - name: ðŸ•’ Keep alive
        run: |
          Write-Host "Giá»¯ phiÃªn hoáº¡t Ä‘á»™ng trong 6 giá»..."
          ping -t 127.0.0.1 > nul
