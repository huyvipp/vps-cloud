name: Windows VNC via Cloudflare

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Set up environment
      shell: pwsh
      run: |
        Write-Host "==> C√†i ƒë·∫∑t m√¥i tr∆∞·ªùng..."
        choco install python -y
        pip install flask

    - name: Download and extract noVNC
      shell: pwsh
      run: |
        Write-Host "==> T·∫£i noVNC..."
        Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/heads/master.zip" -OutFile "novnc.zip"
        Expand-Archive novnc.zip -DestinationPath .
        Rename-Item "noVNC-master" "novnc-master"

        Write-Host "==> T·∫£i Websockify..."
        Invoke-WebRequest -Uri "https://github.com/novnc/websockify/archive/refs/heads/master.zip" -OutFile "websockify.zip"
        Expand-Archive websockify.zip -DestinationPath .
        Rename-Item "websockify-master" "websockify"

    - name: Download Cloudflared
      shell: pwsh
      run: |
        Write-Host "==> C√†i Cloudflared..."
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

    - name: Start VNC Server
      shell: pwsh
      run: |
        Write-Host "==> C√†i UltraVNC..."
        Invoke-WebRequest -Uri "https://www.uvnc.com/downloads/ultravnc/157-download-ultravnc-1224.html" -OutFile "uvnc.zip"
        # b·∫°n c√≥ th·ªÉ thay b·∫±ng tightvnc portable n·∫øu th√≠ch
        Write-Host "==> Kh·ªüi ch·∫°y VNC server..."
        # V√≠ d·ª• test: ch·∫°y fake VNC port
        New-NetFirewallRule -DisplayName "Allow VNC 5900" -Direction Inbound -Protocol TCP -LocalPort 5900 -Action Allow

    - name: Start noVNC
      shell: pwsh
      run: |
        Write-Host "==> Ch·∫°y noVNC server..."
        cd novnc-master
        Start-Process -FilePath "python" -ArgumentList "utils/novnc_proxy --vnc localhost:5900" -WindowStyle Hidden
        Start-Sleep -Seconds 10
        Write-Host "noVNC ƒë√£ kh·ªüi ƒë·ªông tr√™n port 6080"

    - name: Start Cloudflare Tunnel
      shell: pwsh
      run: |
        Write-Host "==> Kh·ªüi ƒë·ªông Cloudflare tunnel..."
        Start-Process -NoNewWindow "cloudflared.exe" -ArgumentList "tunnel --url http://localhost:6080 --no-autoupdate" -RedirectStandardOutput cloudflared.log -RedirectStandardError cloudflared.log
        Start-Sleep -Seconds 15
        $text = Get-Content cloudflared.log -Raw
        if ($text -match "https://[^\s]+trycloudflare\.com") {
          $link = $matches[0]
          Write-Host "üåç LINK TRUY C·∫¨P noVNC WEB:"
          Write-Host "$link/vnc.html"
        } else {
          Write-Host "‚ùå Kh√¥ng th·ªÉ l·∫•y link Cloudflare. H√£y ki·ªÉm tra file log."
          Get-Content cloudflared.log | Out-String
        }

    - name: Keep alive
      shell: pwsh
      run: |
        Write-Host "üî• Gi·ªØ workflow ho·∫°t ƒë·ªông trong 6 ti·∫øng..."
        for ($i=0; $i -lt 21600; $i+=60) {
          Write-Host "‚è±Ô∏è Online... $i gi√¢y"
          Start-Sleep -Seconds 60
        }
